<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EscarBot - Control Panel</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü§ñ</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e4e4e7;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px 20px;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(139, 92, 246, 0.3);
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
            background: linear-gradient(135deg, #ffffff 0%, #e0e7ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 1rem;
            color: #e0e7ff;
            opacity: 0.9;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 3fr;
            gap: 25px;
            margin-bottom: 30px;
            align-items: start;
        }

        @media (max-width: 992px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            height: 100%;
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #a78bfa;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-icon {
            font-size: 1.5rem;
        }

        /* Feature List Styles */
        .feature-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            margin-bottom: 12px;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            cursor: pointer;
        }

        .feature-item:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(139, 92, 246, 0.2);
        }

        .feature-item.active {
            background: rgba(139, 92, 246, 0.1);
            border-color: rgba(139, 92, 246, 0.4);
        }

        .feature-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
        }

        .feature-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: #e4e4e7;
        }

        .feature-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-icon {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #e4e4e7;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon:hover {
            background: rgba(139, 92, 246, 0.2);
            border-color: #8b5cf6;
            color: #a78bfa;
        }

        /* Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 22px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4b5563;
            transition: .3s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        input:checked + .slider:before {
            transform: translateX(22px);
        }

        /* Settings Area Styles */
        .settings-panel {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .settings-panel.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 600px) {
            .input-grid {
                grid-template-columns: 1fr;
            }
        }

        .input-label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #a78bfa;
        }

        input[type="text"], textarea, select {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #e4e4e7;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        input[type="text"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #8b5cf6;
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        select option {
            background: #1a1a2e;
            color: #e4e4e7;
        }

        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        }

        .btn-add {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-remove {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            padding: 10px 18px;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: flex-end;
        }

        .replacer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .replacer-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.03);
            padding: 12px 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .word-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }

        .word-input-group input {
            flex: 1;
        }

        /* Message Section Styles */
        .message-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        @media (max-width: 768px) {
            .message-section {
                grid-template-columns: 1fr;
            }
        }

        .message-cache {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            padding: 15px;
            max-height: 500px;
            overflow-y: auto;
        }

        .cached-message {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .cached-message:hover {
            background: rgba(139, 92, 246, 0.1);
            border-color: rgba(139, 92, 246, 0.3);
        }

        .cached-message-user {
            font-weight: 600;
            color: #8b5cf6;
            font-size: 0.9rem;
        }

        .cached-message-text {
            color: #d1d5db;
            font-size: 0.85rem;
            line-height: 1.4;
            word-break: break-word;
        }

        .placeholder-info {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
            font-size: 0.85rem;
            color: #d1d5db;
        }

        .placeholder-list code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
            color: #10b981;
            font-family: 'Courier New', monospace;
        }

        .link-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }

        .link-input-group input:first-child { flex: 0.4; }
        .link-input-group input:nth-child(2) { flex: 0.6; }

        .empty-selection {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6b7280;
            text-align: center;
            padding: 40px;
        }

        .empty-selection-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* Reactions */
        .reaction-picker {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(26, 22, 37, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .reaction-picker-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
        }

        .reaction-picker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
            gap: 8px;
        }

        .reaction-emoji {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .reaction-emoji:hover {
            background: rgba(139, 92, 246, 0.3);
            transform: scale(1.15);
        }

        .reaction-btn {
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid rgba(139, 92, 246, 0.3);
            padding: 4px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .reaction-count {
            background: rgba(139, 92, 246, 0.15);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-right: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>EscarBot</h1>
            <p class="subtitle">Telegram Bot Control Panel</p>
        </header>

        <div class="main-layout">
            <!-- Features Column -->
            <div class="card">
                <div class="card-title">
                    <span class="card-icon">‚öôÔ∏è</span>
                    Features
                </div>

                <div class="feature-item" id="feature-links" onclick="showSettings('links')">
                    <div class="feature-info">
                        <span class="feature-name">Link detection</span>
                    </div>
                    <div class="feature-actions" onclick="event.stopPropagation()">
                        <label class="switch">
                            <input type="checkbox" id="linkToggle" onchange="toggleFeature('linkToggle', '/setLinks')"{{ if .LinkDetection }} checked{{ end }}>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <div class="feature-item" id="feature-channel" onclick="showSettings('channel')">
                    <div class="feature-info">
                        <span class="feature-name">Channel forward</span>
                    </div>
                    <div class="feature-actions" onclick="event.stopPropagation()">
                        <label class="switch">
                            <input type="checkbox" id="channelForwardToggle" onchange="toggleFeature('channelForwardToggle', '/setChannelForward')"{{ if .ChannelForward }} checked{{ end }}>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <div class="feature-item" id="feature-admin" onclick="showSettings('admin')">
                    <div class="feature-info">
                        <span class="feature-name">Admin forward</span>
                    </div>
                    <div class="feature-actions" onclick="event.stopPropagation()">
                        <label class="switch">
                            <input type="checkbox" id="adminForwardToggle" onchange="toggleFeature('adminForwardToggle', '/setAdminForward')"{{ if .AdminForward }} checked{{ end }}>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <div class="feature-item" id="feature-autoban" onclick="showSettings('autoban')">
                    <div class="feature-info">
                        <span class="feature-name">Auto-ban</span>
                    </div>
                    <div class="feature-actions" onclick="event.stopPropagation()">
                        <label class="switch">
                            <input type="checkbox" id="autoBanToggle" onchange="toggleFeature('autoBanToggle', '/setAutoBan')"{{ if .AutoBan }} checked{{ end }}>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <div class="feature-item" id="feature-captcha" onclick="showSettings('captcha')">
                    <div class="feature-info">
                        <span class="feature-name">Captcha</span>
                    </div>
                    <div class="feature-actions" onclick="event.stopPropagation()">
                        <label class="switch">
                            <input type="checkbox" id="captchaToggle" onchange="toggleFeature('captchaToggle', '/setCaptcha')"{{ if .Captcha }} checked{{ end }}>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <div class="feature-item" id="feature-welcome" onclick="showSettings('welcome')">
                    <div class="feature-info">
                        <span class="feature-name">Welcome message</span>
                    </div>
                    <div class="feature-actions" onclick="event.stopPropagation()">
                        <label class="switch">
                            <input type="checkbox" id="welcomeMessageToggle" onchange="toggleFeature('welcomeMessageToggle', '/setWelcomeMessage')"{{ if .WelcomeMessage }} checked{{ end }}>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Settings Column -->
            <div class="card" id="settings-container">
                <div class="empty-selection" id="empty-settings">
                    <div class="empty-selection-icon">üõ†Ô∏è</div>
                    <h2>Select a feature to configure</h2>
                    <p>Click a feature to see its settings.</p>
                </div>

                <!-- Link Detection Settings -->
                <div class="settings-panel" id="settings-links">
                    <div class="card-title">Link detection settings</div>
                    <p style="margin-bottom: 20px; color: #9ca3af;">Enable or disable individual link transformers.</p>
                    <div class="replacer-grid">
                        {{ range .AllReplacers }}
                        <div class="replacer-item" title="{{ .Regex.String }}">
                            <span style="font-size: 0.9rem;">{{ .Name }}</span>
                            <label class="switch">
                                <input type="checkbox" class="replacer-toggle" data-name="{{ .Name }}"
                                    {{ if index $.EnabledReplacers .Name }} checked{{ end }}
                                    onchange="toggleReplacer(this)">
                                <span class="slider"></span>
                            </label>
                        </div>
                        {{ end }}
                    </div>
                </div>

                <!-- Channel Forward Settings -->
                <div class="settings-panel" id="settings-channel">
                    <div class="card-title">Channel forward settings</div>
                    <form onsubmit="updateId(event, '/setChannel', 'channelId')">
                        <div class="input-group">
                            <label class="input-label" for="channelId">Channel ID</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="channelId" name="id" value="{{ .ChannelID }}" placeholder="Enter channel ID" required>
                                <button type="submit">Update</button>
                            </div>
                        </div>
                    </form>
                    <form onsubmit="updateId(event, '/setGroup', 'groupId')">
                        <div class="input-group">
                            <label class="input-label" for="groupId">Group ID</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="groupId" name="id" value="{{ .GroupID }}" placeholder="Enter group ID" required>
                                <button type="submit">Update</button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Admin Forward Settings -->
                <div class="settings-panel" id="settings-admin">
                    <div class="card-title">Admin forward settings</div>
                    <form onsubmit="updateId(event, '/setAdmin', 'adminId')">
                        <div class="input-group">
                            <label class="input-label" for="adminId">Admin ID</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="adminId" name="id" value="{{ .AdminID }}" placeholder="Enter admin ID" required>
                                <button type="submit">Update</button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Auto Ban Settings -->
                <div class="settings-panel" id="settings-autoban">
                    <div class="card-title">Auto-ban settings</div>
                    <form id="bannedWordsForm">
                        <label class="input-label">Banned words</label>
                        <div id="bannedWordsContainer">
                            {{ range .BannedWords }}
                            <div class="word-input-group">
                                <input type="text" name="word" value="{{ . }}" placeholder="Enter banned word">
                                <button type="button" class="btn-remove" onclick="this.parentElement.remove()">üóëÔ∏è</button>
                            </div>
                            {{ end }}
                        </div>
                        <div class="button-group">
                            <button type="button" class="btn-add" onclick="addBannedWord()">Add</button>
                            <button type="submit">Save</button>
                        </div>
                    </form>
                </div>

                <!-- Captcha Settings -->
                <div class="settings-panel" id="settings-captcha">
                    <div class="card-title">Captcha settings</div>
                    <div class="placeholder-info">
                        <strong>Placeholders:</strong> <code>{USER_NAME}</code>, <code>{USER_ID}</code>, <code>{GROUP_ID}</code>, <code>{TIMEOUT}</code>
                    </div>
                    <form onsubmit="updateCaptchaConfig(event)">
                        <div class="input-group">
                            <label class="input-label" for="captchaText">Captcha text (Markdown)</label>
                            <textarea id="captchaText" name="captchaText" placeholder="Enter captcha message...">{{ .CaptchaText }}</textarea>
                        </div>
                        <div class="input-grid">
                            <div class="input-group">
                                <label class="input-label" for="captchaTimeout">Timeout (seconds)</label>
                                <input type="text" id="captchaTimeout" name="timeout" value="{{ .CaptchaTimeout }}" placeholder="120" required>
                            </div>
                            <div class="input-group">
                                <label class="input-label" for="captchaMaxRetries">Max retries</label>
                                <input type="text" id="captchaMaxRetries" name="maxRetries" value="{{ .CaptchaMaxRetries }}" placeholder="2" required>
                            </div>
                        </div>
                        <div class="button-group">
                            <button type="submit">Save</button>
                        </div>
                    </form>
                    <hr style="margin: 20px 0; border: 0; border-top: 1px solid rgba(255,255,255,0.1);">
                    <p style="margin-bottom: 20px; color: #9ca3af;">When enabled, new users must solve a 4-digit captcha within the specified timeout.</p>
                    <p style="color: #9ca3af;">Failure to solve the captcha (including exhausting retries) results in a ban, similar to auto-ban.</p>
                </div>


                <!-- Welcome Message Settings -->
                <div class="settings-panel" id="settings-welcome">
                    <div class="card-title">Welcome message settings</div>
                    <div class="placeholder-info">
                        <strong>Placeholders:</strong> <code>{USER_NAME}</code>, <code>{USER_ID}</code>, <code>{GROUP_ID}</code>
                    </div>
                    <form id="welcomeSettingsForm">
                        <div class="input-group">
                            <label class="input-label" for="welcomeText">Message text (Markdown)</label>
                            <textarea id="welcomeText" name="welcomeText" placeholder="Enter welcome message...">{{ .WelcomeText }}</textarea>
                        </div>
                        <div class="input-group">
                            <label class="input-label" for="welcomePhoto">Photo URL (optional)</label>
                            <input type="text" id="welcomePhoto" name="welcomePhoto" value="{{ .WelcomePhoto }}" placeholder="https://example.com/image.jpg">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Button links</label>
                            <div id="welcomeLinksContainer"></div>
                            <button type="button" class="btn-add" onclick="addWelcomeLink()" style="margin-top: 10px;">Add</button>
                        </div>
                        <div class="button-group">
                            <button type="submit">Save</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Send Message Card -->
        <div class="card" style="margin-bottom: 30px;">
            <div class="card-title">
                <span class="card-icon">üí¨</span>
                Send message
            </div>

            <div class="message-section">
                <form id="messageForm">
                    <div class="input-group">
                        <label class="input-label" for="customMessage">Message content</label>
                        <textarea id="customMessage" name="customMessage" placeholder="Enter your message here..." required></textarea>
                    </div>

                    <div class="input-grid">
                        <div class="input-group">
                            <label class="input-label" for="recipientId">Recipient ID</label>
                            <div style="display: flex; gap: 5px;">
                                <input type="text" id="recipientId" name="recipientId" value="{{ .GroupID }}" required>
                                <button type="button" class="btn-icon" onclick="document.getElementById('recipientId').value = '{{ .GroupID }}'" title="Set to Group ID">üîÑ</button>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label" for="parseMode">Parse mode</label>
                            <select id="parseMode" name="parseMode">
                                <option value="">Plaintext</option>
                                <option value="Markdown">Markdown</option>
                                <option value="MarkdownV2">MarkdownV2</option>
                                <option value="HTML">HTML</option>
                            </select>
                        </div>
                    </div>

                    <div class="input-grid">
                        <div class="input-group">
                            <label class="input-label" for="threadId">Thread ID</label>
                            <div style="display: flex; gap: 5px;">
                                <input type="text" id="threadId" name="threadId" placeholder="Optional">
                                <button type="button" class="btn-icon" onclick="document.getElementById('threadId').value = ''" title="Clear">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label" for="replyToMessageId">Reply to ID</label>
                            <div style="display: flex; gap: 5px;">
                                <input type="text" id="replyToMessageId" name="replyToMessageId" placeholder="Optional">
                                <button type="button" class="btn-icon" onclick="document.getElementById('replyToMessageId').value = ''" title="Clear">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>

                    <button type="button" id="customMessageButton" class="btn-secondary" style="width: 100%;">Send</button>
                </form>

                <div>
                    <label class="input-label">Recent messages</label>
                    <div class="message-cache" id="messageCache">
                        <div class="no-messages" style="text-align: center; padding: 20px; color: #6b7280;">Loading messages...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reaction Picker Modal -->
    <div class="reaction-picker-overlay" id="reactionOverlay" onclick="closeReactionPicker()"></div>
    <div class="reaction-picker" id="reactionPicker">
        <div class="card-title" style="justify-content: center;">Select reaction</div>
        <div class="reaction-picker-grid" id="reactionGrid"></div>
    </div>

    <script>
        const baseUrl = "https://api.telegram.org/bot{{ .Bot.Token }}/";
        let messageCache = [];
        let welcomeLinksData = {{ .WelcomeLinks | toJSON }};

        // --- UI Switching ---
        function showSettings(panelId) {
            // Update active state in feature list
            document.querySelectorAll('.feature-item').forEach(el => el.classList.remove('active'));
            document.getElementById('feature-' + panelId).classList.add('active');

            // Show selected panel
            document.getElementById('empty-settings').style.display = 'none';
            document.querySelectorAll('.settings-panel').forEach(el => el.classList.remove('active'));
            document.getElementById('settings-' + panelId).classList.add('active');

            if (panelId === 'welcome') {
                renderWelcomeLinks();
            }
        }

        // --- Feature Toggles ---
        function toggleFeature(id, endpoint) {
            const checkbox = document.getElementById(id);
            const params = new URLSearchParams();
            params.append('toggle', checkbox.checked ? 'on' : 'off');

            fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: params
            }).catch(err => {
                console.error('Error:', err);
                checkbox.checked = !checkbox.checked; // Revert
            });
        }

        function toggleReplacer(checkbox) {
            const name = checkbox.getAttribute('data-name');
            const params = new URLSearchParams();
            params.append('name', name);
            params.append('toggle', checkbox.checked ? 'on' : 'off');

            fetch('/setReplacer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: params
            }).catch(err => {
                console.error('Error:', err);
                checkbox.checked = !checkbox.checked;
            });
        }

        // --- Captcha Config ---
        function updateCaptchaConfig(event) {
            event.preventDefault();
            const timeout = document.getElementById('captchaTimeout').value;
            const maxRetries = document.getElementById('captchaMaxRetries').value;
            const captchaText = document.getElementById('captchaText').value;
            const params = new URLSearchParams();
            params.append('timeout', timeout);
            params.append('maxRetries', maxRetries);
            params.append('captchaText', captchaText);

            const btn = event.target.querySelector('button');
            const originalText = btn.textContent;

            fetch('/setCaptchaConfig', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: params
            }).then(() => {
                btn.textContent = 'Saved!';
                setTimeout(() => btn.textContent = originalText, 2000);
            });
        }

        // --- ID Updates ---
        function updateId(event, endpoint, inputId) {
            event.preventDefault();
            const val = document.getElementById(inputId).value;
            const params = new URLSearchParams();
            params.append('id', val);

            const btn = event.target.querySelector('button');
            const originalText = btn.textContent;

            fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: params
            }).then(() => {
                btn.textContent = '‚úì';
                btn.style.background = '#10b981';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            });
        }

        // --- Banned Words ---
        function addBannedWord(value = '') {
            const container = document.getElementById('bannedWordsContainer');
            const div = document.createElement('div');
            div.className = 'word-input-group';
            div.innerHTML = `
                <input type="text" name="word" value="${value}" placeholder="Enter banned word">
                <button type="button" class="btn-remove" onclick="this.parentElement.remove()">üóëÔ∏è</button>
            `;
            container.appendChild(div);
        }

        document.getElementById('bannedWordsForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const params = new URLSearchParams();
            formData.forEach((value, key) => params.append(key, value));
            const btn = e.target.querySelector('button[type="submit"]');

            fetch('/setBannedWords', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: params
            }).then(() => {
                btn.textContent = 'Saved!';
                setTimeout(() => btn.textContent = 'Save All', 2000);
            });
        });

        // --- Welcome Message ---
        function renderWelcomeLinks() {
            const container = document.getElementById('welcomeLinksContainer');
            container.innerHTML = '';

            const links = welcomeLinksData ? welcomeLinksData.split('\n').filter(l => l.includes('|')) : [];
            if (links.length === 0) {
                addWelcomeLink();
            } else {
                links.forEach(l => {
                    const [text, url] = l.split('|');
                    addWelcomeLink(text, url);
                });
            }
        }

        function addWelcomeLink(text = '', url = '') {
            const container = document.getElementById('welcomeLinksContainer');
            const div = document.createElement('div');
            div.className = 'link-input-group';
            div.innerHTML = `
                <input type="text" name="linkText" value="${text}" placeholder="Button Text">
                <input type="text" name="linkUrl" value="${url}" placeholder="URL">
                <button type="button" class="btn-remove" onclick="this.parentElement.remove()">üóëÔ∏è</button>
            `;
            container.appendChild(div);
        }

        document.getElementById('welcomeSettingsForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const texts = Array.from(e.target.querySelectorAll('input[name="linkText"]')).map(i => i.value);
            const urls = Array.from(e.target.querySelectorAll('input[name="linkUrl"]')).map(i => i.value);

            const links = [];
            for(let i=0; i<texts.length; i++) {
                if(texts[i] && urls[i]) links.push(`${texts[i]}|${urls[i]}`);
            }
            const linksStr = links.join('\n');

            const params = new URLSearchParams();
            params.append('welcomeText', document.getElementById('welcomeText').value);
            params.append('welcomePhoto', document.getElementById('welcomePhoto').value);
            params.append('welcomeLinks', linksStr);

            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.textContent;

            fetch('/setWelcomeContent', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: params
            }).then(() => {
                welcomeLinksData = linksStr;
                btn.textContent = 'Saved!';
                setTimeout(() => btn.textContent = originalText, 2000);
            });
        });

        // --- Messaging ---
        document.getElementById("customMessageButton").addEventListener("click", (e) => {
            const btn = e.target;
            const originalText = btn.textContent;
            const text = document.getElementById("customMessage").value;
            const chat_id = document.getElementById("recipientId").value;
            const reply_to = document.getElementById("replyToMessageId").value;
            const thread_id = document.getElementById("threadId").value;
            const parse_mode = document.getElementById("parseMode").value;

            if(!text || !chat_id) {
                btn.textContent = 'Required fields missing!';
                btn.style.background = '#ef4444';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
                return;
            }

            const params = new URLSearchParams({ text, chat_id });
            if(reply_to) params.append('reply_to_message_id', reply_to);
            if(thread_id) params.append('message_thread_id', thread_id);
            if(parse_mode) params.append('parse_mode', parse_mode);

            fetch(baseUrl + "sendMessage?" + params)
                .then(r => r.json())
                .then(data => {
                    if(data.ok) {
                        document.getElementById("customMessage").value = "";
                        document.getElementById("threadId").value = "";
                        document.getElementById("replyToMessageId").value = "";
                        btn.textContent = 'Sent!';
                        btn.style.background = '#10b981';
                    } else {
                        btn.textContent = 'Error!';
                        btn.style.background = '#ef4444';
                        console.error('Telegram Error:', data.description);
                    }
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                    }, 2000);
                });
        });

        // --- WebSocket & Cache ---
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

            ws.onopen = () => fetch('/api/messageCache').then(r => r.json()).then(msgs => {
                messageCache = msgs;
                renderMessages();
            });

            ws.onmessage = (e) => {
                messageCache.unshift(JSON.parse(e.data));
                if(messageCache.length > 100) messageCache.pop();
                renderMessages();
            };

            ws.onclose = () => setTimeout(connectWebSocket, 3000);
        }

        function renderMessages() {
            const container = document.getElementById('messageCache');
            if(messageCache.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:#6b7280;padding:20px;">No messages yet</div>';
                return;
            }

            container.innerHTML = messageCache.map(msg => `
                <div class="cached-message" onclick='selectMessage(${JSON.stringify(msg)})'>
                    <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                        <span class="cached-message-user">${msg.from_first_name || 'User'} ${msg.chat_title ? `(${msg.chat_title})` : `[${msg.chat_id}]`}</span>
                        <div style="display:flex;gap:5px;">
                            <button class="reaction-btn" onclick='event.stopPropagation(); showReactionPicker(${msg.chat_id}, ${msg.message_id}, ${JSON.stringify(msg.available_reactions || [])})'>üòä</button>
                            <span style="font-size:0.7rem;color:#9ca3af;">#${msg.message_id}</span>
                        </div>
                    </div>
                    <div class="cached-message-text">${msg.text || '<media>'}</div>
                    <div style="margin-top:5px;">
                        ${(msg.reactions || []).map(r => `<span class="reaction-count">${r.type.emoji} ${r.total_count}</span>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        function selectMessage(msg) {
            document.getElementById('recipientId').value = msg.chat_id;
            document.getElementById('replyToMessageId').value = msg.message_id;
            document.getElementById('threadId').value = msg.is_topic_message ? msg.thread_id : '';

            // Visual feedback
            const btn = document.getElementById('customMessageButton');
            const originalText = btn.textContent;
            btn.textContent = '‚úì Message selected';
            setTimeout(() => {
                btn.textContent = originalText;
            }, 1500);
        }

        // --- Reactions ---
        let currReactChat, currReactMsg;
        function showReactionPicker(chatId, msgId, reactions) {
            currReactChat = chatId; currReactMsg = msgId;
            const grid = document.getElementById('reactionGrid');
            grid.innerHTML = (reactions.length ? reactions : ["üëç", "‚ù§Ô∏è", "üî•", "üëè"]).map(emoji =>
                `<div class="reaction-emoji" onclick="sendReaction('${emoji}')">${emoji}</div>`
            ).join('');
            document.getElementById('reactionOverlay').style.display = 'block';
            document.getElementById('reactionPicker').style.display = 'block';
        }

        function closeReactionPicker() {
            document.getElementById('reactionOverlay').style.display = 'none';
            document.getElementById('reactionPicker').style.display = 'none';
        }

        function sendReaction(emoji) {
            const params = new URLSearchParams({
                chat_id: currReactChat,
                message_id: currReactMsg,
                reaction: JSON.stringify([{type: "emoji", emoji}])
            });
            fetch(baseUrl + "setMessageReaction?" + params).then(r => r.json()).then(data => {
                if(data.ok) {
                    const msg = messageCache.find(m => m.message_id === currReactMsg && m.chat_id === currReactChat);
                    if(msg) msg.reactions = [{type: {emoji}, total_count: 1}];
                    renderMessages();
                    closeReactionPicker();
                }
            });
        }

        // Initialize
        showSettings('links');
        connectWebSocket();
    </script>
</body>
</html>
